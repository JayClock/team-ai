<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.businessdrivenai.persistence.mybatis.mappers.ProjectConversationsMapper">

  <resultMap id="conversation" type="com.businessdrivenai.domain.model.Conversation">
    <id property="identity" column="id" jdbcType="VARCHAR" javaType="String"/>
    <association property="description" javaType="com.businessdrivenai.domain.description.ConversationDescription">
      <constructor>
        <arg column="title" jdbcType="VARCHAR" javaType="String"/>
      </constructor>
    </association>
    <association property="messages" javaType="com.businessdrivenai.persistence.mybatis.associations.ConversationMessages">
      <result column="id" property="conversationId" javaType="int"/>
    </association>
  </resultMap>

  <select id="findConversationByProjectAndId" resultMap="conversation">
    SELECT c.id, c.title
    FROM conversations c
    WHERE c.project_id = #{project_id} AND c.id = #{id}
  </select>

  <insert id="insertConversation" useGeneratedKeys="true" keyProperty="holder.id" keyColumn="id"
          parameterType="com.businessdrivenai.persistence.support.IdHolder">
    INSERT INTO conversations(title, project_id)
    VALUES (#{description.title}, #{project_id})
  </insert>

  <delete id="deleteConversation">
    DELETE FROM conversations
    WHERE project_id = #{project_id} AND id = #{id}
  </delete>

  <select id="findConversationsByProjectId" resultMap="conversation">
    SELECT c.id, c.title
    FROM conversations c
    WHERE c.project_id = #{project_id}
    LIMIT #{size} OFFSET #{from}
  </select>

  <select id="countConversationsByProject" resultType="int">
    SELECT COUNT(id) FROM conversations WHERE project_id = #{project_id}
  </select>
</mapper>
