<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reengineering.ddd.teamai.mybatis.mappers.DiagramNodesMapper">

  <resultMap id="logicalEntity" type="reengineering.ddd.teamai.model.LogicalEntity">
    <id property="identity" column="le_id" jdbcType="VARCHAR" javaType="String"/>
    <association property="description" javaType="reengineering.ddd.teamai.description.LogicalEntityDescription">
      <constructor>
        <arg column="le_type" jdbcType="VARCHAR" typeHandler="reengineering.ddd.teamai.mybatis.typehandler.LogicalEntityTypeHandler" javaType="reengineering.ddd.teamai.description.LogicalEntityDescription$Type"/>
        <arg column="le_sub_type" jdbcType="VARCHAR" typeHandler="reengineering.ddd.teamai.mybatis.typehandler.SubTypeHandler" javaType="reengineering.ddd.teamai.description.LogicalEntityDescription$SubType"/>
        <arg column="le_name" jdbcType="VARCHAR" javaType="String"/>
        <arg column="le_label" jdbcType="VARCHAR" javaType="String"/>
        <arg column="le_definition" jdbcType="OTHER" typeHandler="reengineering.ddd.teamai.mybatis.typehandler.EntityDefinitionHandler" javaType="reengineering.ddd.teamai.description.EntityDefinition"/>
      </constructor>
    </association>
  </resultMap>

  <resultMap id="node" type="reengineering.ddd.teamai.model.DiagramNode">
    <id property="identity" column="id" jdbcType="INTEGER" javaType="String"/>
    <association property="description" javaType="reengineering.ddd.teamai.description.NodeDescription">
      <constructor>
        <arg column="type" jdbcType="VARCHAR" javaType="String"/>
        <arg column="logical_entity_id" jdbcType="INTEGER" javaType="reengineering.ddd.archtype.Ref" typeHandler="reengineering.ddd.mybatis.support.RefIntegerTypeHandler"/>
        <arg column="parent_id" jdbcType="INTEGER" javaType="reengineering.ddd.archtype.Ref" typeHandler="reengineering.ddd.mybatis.support.RefIntegerTypeHandler"/>
        <arg column="position_x" jdbcType="NUMERIC" javaType="_double"/>
        <arg column="position_y" jdbcType="NUMERIC" javaType="_double"/>
        <arg column="width" jdbcType="INTEGER" javaType="Integer"/>
        <arg column="height" jdbcType="INTEGER" javaType="Integer"/>
        <arg column="style_config" jdbcType="OTHER" typeHandler="reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler" javaType="reengineering.ddd.archtype.JsonBlob"/>
        <arg column="local_data" jdbcType="OTHER" typeHandler="reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler" javaType="reengineering.ddd.archtype.JsonBlob"/>
      </constructor>
    </association>
    <association property="logicalEntity" javaType="reengineering.ddd.mybatis.memory.Reference">
      <association property="entity" resultMap="logicalEntity" notNullColumn="le_id"/>
    </association>
  </resultMap>

  <select id="findNodeByDiagramAndId" resultMap="node">
    SELECT
      dn.id,
      dn.diagram_id,
      dn.type,
      dn.logical_entity_id,
      dn.parent_id,
      dn.position_x,
      dn.position_y,
      dn.width,
      dn.height,
      dn.style_config,
      dn.local_data,
      le.id as le_id,
      le.type as le_type,
      le.sub_type as le_sub_type,
      le.name as le_name,
      le.label as le_label,
      le.definition as le_definition
    FROM diagram_nodes dn
    JOIN diagrams d ON dn.diagram_id = d.id
    LEFT JOIN logical_entities le ON dn.logical_entity_id = le.id AND le.project_id = d.project_id
    WHERE dn.diagram_id = #{diagram_id} AND dn.id = #{id}
  </select>

  <select id="findNodesByDiagramId" resultMap="node">
    SELECT
      dn.id,
      dn.diagram_id,
      dn.type,
      dn.logical_entity_id,
      dn.parent_id,
      dn.position_x,
      dn.position_y,
      dn.width,
      dn.height,
      dn.style_config,
      dn.local_data,
      le.id as le_id,
      le.type as le_type,
      le.sub_type as le_sub_type,
      le.name as le_name,
      le.label as le_label,
      le.definition as le_definition
    FROM diagram_nodes dn
    JOIN diagrams d ON dn.diagram_id = d.id
    LEFT JOIN logical_entities le ON dn.logical_entity_id = le.id AND le.project_id = d.project_id
    WHERE dn.diagram_id = #{diagram_id}
    ORDER BY dn.updated_at DESC
  </select>

  <insert id="insertNode" useGeneratedKeys="true" keyProperty="holder.id" keyColumn="id"
          parameterType="reengineering.ddd.mybatis.support.IdHolder">
    INSERT INTO diagram_nodes(diagram_id, type, logical_entity_id, parent_id, position_x, position_y, width, height, style_config, local_data)
    VALUES (#{diagram_id},
            #{description.type},
            #{description.logicalEntity, typeHandler=reengineering.ddd.mybatis.support.RefIntegerTypeHandler},
            #{description.parent, typeHandler=reengineering.ddd.mybatis.support.RefIntegerTypeHandler},
            #{description.positionX},
            #{description.positionY},
            #{description.width},
            #{description.height},
            #{description.styleConfig, typeHandler=reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler},
            #{description.localData, typeHandler=reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler})
  </insert>

  <update id="updateNode">
    UPDATE diagram_nodes
    SET type = #{description.type},
        logical_entity_id = #{description.logicalEntity, typeHandler=reengineering.ddd.mybatis.support.RefIntegerTypeHandler},
        parent_id = #{description.parent, typeHandler=reengineering.ddd.mybatis.support.RefIntegerTypeHandler},
        position_x = #{description.positionX},
        position_y = #{description.positionY},
        width = #{description.width},
        height = #{description.height},
        style_config = #{description.styleConfig, typeHandler=reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler},
        local_data = #{description.localData, typeHandler=reengineering.ddd.teamai.mybatis.typehandler.JsonBlobHandler},
        updated_at = CURRENT_TIMESTAMP
    WHERE diagram_id = #{diagram_id}
      AND id = #{id}
  </update>

  <select id="findNodeIdsWithoutLogicalEntityForPublish" resultType="int">
    SELECT dn.id
    FROM diagram_nodes dn
    INNER JOIN diagrams d ON d.id = dn.diagram_id
    WHERE d.project_id = #{project_id}
      AND dn.diagram_id = #{diagram_id}
      AND dn.logical_entity_id IS NULL
    ORDER BY dn.id
  </select>

  <update id="promoteNodeLocalDataToLogicalEntity">
    WITH source_node AS (
      SELECT
        d.project_id AS project_id,
        dn.id AS node_id,
        CASE UPPER(COALESCE(dn.local_data ->> 'type', ''))
          WHEN 'EVIDENCE' THEN 'Evidence'
          WHEN 'PARTICIPANT' THEN 'Participant'
          WHEN 'ROLE' THEN 'Role'
          WHEN 'CONTEXT' THEN 'Context'
          ELSE NULL
        END AS logical_type,
        CASE UPPER(COALESCE(dn.local_data ->> 'type', ''))
          WHEN 'EVIDENCE' THEN
            CASE
              WHEN POSITION(':' IN COALESCE(dn.local_data ->> 'subType', '')) > 0
                THEN dn.local_data ->> 'subType'
              ELSE 'EVIDENCE:' || COALESCE(NULLIF(dn.local_data ->> 'subType', ''), 'rfp')
            END
          WHEN 'PARTICIPANT' THEN
            CASE
              WHEN POSITION(':' IN COALESCE(dn.local_data ->> 'subType', '')) > 0
                THEN dn.local_data ->> 'subType'
              ELSE 'PARTICIPANT:' || COALESCE(NULLIF(dn.local_data ->> 'subType', ''), 'party')
            END
          WHEN 'ROLE' THEN
            CASE
              WHEN POSITION(':' IN COALESCE(dn.local_data ->> 'subType', '')) > 0
                THEN dn.local_data ->> 'subType'
              ELSE 'ROLE:' || COALESCE(NULLIF(dn.local_data ->> 'subType', ''), 'party_role')
            END
          WHEN 'CONTEXT' THEN
            CASE
              WHEN POSITION(':' IN COALESCE(dn.local_data ->> 'subType', '')) > 0
                THEN dn.local_data ->> 'subType'
              ELSE 'CONTEXT:' || COALESCE(NULLIF(dn.local_data ->> 'subType', ''), 'bounded_context')
            END
          ELSE NULL
        END AS logical_sub_type,
        NULLIF(BTRIM(dn.local_data ->> 'name'), '') AS logical_name,
        COALESCE(
          NULLIF(BTRIM(dn.local_data ->> 'label'), ''),
          NULLIF(BTRIM(dn.local_data ->> 'name'), '')
        ) AS logical_label,
        COALESCE(dn.local_data -> 'definition', '{}'::jsonb) AS logical_definition
      FROM diagram_nodes dn
      INNER JOIN diagrams d ON d.id = dn.diagram_id
      WHERE d.project_id = #{project_id}
        AND dn.diagram_id = #{diagram_id}
        AND dn.id = #{node_id}
        AND dn.logical_entity_id IS NULL
    ),
    inserted_entity AS (
      INSERT INTO logical_entities(project_id, type, sub_type, name, label, definition)
      SELECT
        project_id,
        logical_type,
        logical_sub_type,
        logical_name,
        logical_label,
        logical_definition
      FROM source_node
      WHERE logical_type IS NOT NULL
        AND logical_name IS NOT NULL
      RETURNING id
    )
    UPDATE diagram_nodes dn
    SET logical_entity_id = inserted_entity.id,
        local_data = '{}'::jsonb,
        updated_at = CURRENT_TIMESTAMP
    FROM inserted_entity
    WHERE dn.id = #{node_id}
      AND dn.diagram_id = #{diagram_id}
      AND dn.logical_entity_id IS NULL
  </update>

  <select id="countNodesByDiagram" resultType="int">
    SELECT COUNT(id) FROM diagram_nodes WHERE diagram_id = #{diagram_id}
  </select>

</mapper>
