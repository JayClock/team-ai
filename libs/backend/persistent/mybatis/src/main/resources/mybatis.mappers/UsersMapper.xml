<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reengineering.ddd.teamai.mybatis.mappers.UsersMapper">
  <resultMap id="user" type="reengineering.ddd.teamai.model.User">
    <id property="identity" column="id" jdbcType="BIGINT" javaType="String"/>
    <association property="description" javaType="reengineering.ddd.teamai.description.UserDescription">
      <constructor>
        <arg column="name" jdbcType="VARCHAR" javaType="String"/>
        <arg column="email" jdbcType="VARCHAR" javaType="String"/>
      </constructor>
    </association>
    <association property="accounts" javaType="reengineering.ddd.teamai.mybatis.associations.UserAccounts">
      <result column="id" property="userId" javaType="String"/>
      <collection property="list" resultMap="reengineering.ddd.teamai.mybatis.mappers.AccountsMapper.account"
                  ofType="reengineering.ddd.teamai.model.Account"/>
    </association>
  </resultMap>

  <select id="findUserById" resultMap="user">
    SELECT u.ID,
           u.NAME,
           u.EMAIL,
           a.ID as account_id,
           a.PROVIDER,
           a.PROVIDER_ID
    FROM USERS u
           LEFT JOIN ACCOUNTS a ON u.ID = a.USER_ID
    WHERE u.ID = #{id}
  </select>

  <insert id="insertUser" useGeneratedKeys="true" keyProperty="holder.id" keyColumn="id"
          parameterType="reengineering.ddd.mybatis.support.IdHolder">
    insert into USERS (NAME, EMAIL)
    VALUES (#{description.name}, #{description.email})
  </insert>
</mapper>
