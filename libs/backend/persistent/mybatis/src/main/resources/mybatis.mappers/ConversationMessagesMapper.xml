<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.businessdrivenai.persistence.mybatis.mappers.ConversationMessagesMapper">

  <resultMap id="message" type="com.businessdrivenai.domain.model.Message">
    <id property="identity" column="id" jdbcType="BIGINT" javaType="String"/>
    <association property="description" javaType="com.businessdrivenai.domain.description.MessageDescription">
      <constructor>
        <arg column="role" jdbcType="VARCHAR" javaType="String"/>
        <arg column="content" jdbcType="VARCHAR" javaType="String"/>
      </constructor>
    </association>
  </resultMap>
  <select id="findMessageByConversationAndId" resultMap="message">
    select id,
           role,
           content
    from messages
    where conversation_id = #{conversation_id}
      and id = #{id}
  </select>

  <select id="countMessagesByConversation" resultType="int">
    select count(id)
    from messages
    where conversation_id = #{conversation_id}
  </select>

  <insert id="insertMessage" useGeneratedKeys="true" keyProperty="holder.id" keyColumn="id"
          parameterType="com.businessdrivenai.persistence.support.IdHolder">
    insert into messages (conversation_id, role, content)
    values (#{conversation_id}, #{description.role}, #{description.content})
  </insert>

  <select id="subMessagesByConversation" resultMap="message">
    select id,
           role,
           content
    from messages
    where conversation_id = #{conversation_id}
    limit #{size} offset #{from}
  </select>
</mapper>
