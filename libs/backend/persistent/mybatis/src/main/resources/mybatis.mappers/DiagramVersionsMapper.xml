<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reengineering.ddd.teamai.mybatis.mappers.DiagramVersionsMapper">

  <resultMap id="version" type="reengineering.ddd.teamai.model.DiagramVersion">
    <id property="identity" column="id" jdbcType="INTEGER" javaType="String"/>
    <association property="description" javaType="reengineering.ddd.teamai.description.DiagramVersionDescription">
      <constructor>
        <arg column="version_name" jdbcType="VARCHAR" javaType="String"/>
        <arg column="snapshot_data" jdbcType="OTHER"
             typeHandler="reengineering.ddd.teamai.mybatis.typehandler.DiagramSnapshotHandler"
             javaType="reengineering.ddd.teamai.description.DiagramVersionDescription$DiagramSnapshot"/>
      </constructor>
    </association>
  </resultMap>

  <select id="findVersionByDiagramAndId" resultMap="version">
    SELECT id, diagram_id, version_name, snapshot_data
    FROM diagram_versions
    WHERE diagram_id = #{diagram_id} AND id = #{id}
  </select>

  <select id="findVersionsByDiagramId" resultMap="version">
    SELECT id, diagram_id, version_name, snapshot_data
    FROM diagram_versions
    WHERE diagram_id = #{diagram_id}
    ORDER BY created_at DESC, id DESC
    LIMIT #{size} OFFSET #{from}
  </select>

  <insert id="insertVersion" useGeneratedKeys="true" keyProperty="holder.id" keyColumn="id"
          parameterType="reengineering.ddd.mybatis.support.IdHolder">
    INSERT INTO diagram_versions(diagram_id, version_name, snapshot_data)
    VALUES (#{diagram_id},
            #{description.name},
            #{description.snapshot, typeHandler=reengineering.ddd.teamai.mybatis.typehandler.DiagramSnapshotHandler})
  </insert>

  <select id="countVersionsByDiagram" resultType="int">
    SELECT COUNT(id) FROM diagram_versions WHERE diagram_id = #{diagram_id}
  </select>

</mapper>
